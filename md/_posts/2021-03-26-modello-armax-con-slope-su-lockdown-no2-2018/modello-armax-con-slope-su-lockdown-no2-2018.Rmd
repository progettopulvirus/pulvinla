---
title: "Modello ARMAX con slope su lockdown NO2, 2018"
description: |
  Serie Lombardia - Piemonte.
author:
  - name: guidofioravanti
date: 03-25-2021
output:
  distill::distill_article:
    self_contained: false
---

Analisi dei risultati del modello ARMAX.

$y=\alpha_{0}+\beta_{1} * meteo+\beta_{2} * banda+\beta_{3} * lockdown+\beta_{4} * lockdown * banda+\beta_{5} * weekend+\varepsilon$

banda: da 1 a numero di giorni dal primo gennaio 2018 al 3 gennaio 2018

lockdown: pari a 1 durante il lockdown (9 marzo - 3 maggio 2018) altrimenti pari a 0

weekend: pari a 1 il sabato e la domenica, altrimenti pari a zero


```{r setup,include = FALSE,message = FALSE,warning = FALSE,echo=FALSE,error=FALSE}
rm(list=objects())
library("tidyverse")
library("visdat")
library("scico")

knitr::opts_chunk$set(include = TRUE,message = FALSE,warning = FALSE,echo=FALSE,error=FALSE,layout="l-page")

readRDS("_out_no2.RDS")->out

out %>%
  mutate(coef_sig=ifelse(pvalue<0.05,coeff,NA)) %>%
  dplyr::select(station_eu_code,coef_sig,variabili) %>%
  spread(key=variabili,value=coef_sig)->risultati

ncol(risultati)->num_col
```

### Percentuale dei parametri significativi e non

**Missing**: parametro non significativo

**Present**: parametro significativo (pvalue<0.05)


```{r,fig.width=12,fig.height=6}
vis_miss(risultati[,2:num_col],cluster = TRUE)
```

## Stima dei beta (heatmap)

Il grafico riporta solo i beta significativi (pvalue < 0.05).

```{r,fig.height=10,fig.width=12}
out %>%
  mutate(coef_sig=ifelse(pvalue<0.05,coeff,NA))%>%
  #filter(variabili!="intercept") %>%
  ggplot(data=.)+geom_tile(aes(x=variabili,y=station_eu_code,fill=coef_sig))+
  geom_text(aes(x=variabili,y=station_eu_code,label=coef_sig),size=3)+
  scale_fill_scico(palette="vik",limits=c(-5,5),na.value="transparent")+
  theme_minimal()+
  theme(panel.grid = element_blank())
```
### Serie osservate, forecast & counterfactual


```{r,include=FALSE}
readRDS("_dati_staz_no2.RDS")->dati
dati%>%
  dplyr::select(station_eu_code,date,value,predfitted,predcounterf) %>%
  gather(key="tipo_serie",value="value",-station_eu_code,-date) %>%
  mutate(tipo_serie=case_when(tipo_serie=="value"~"Serie osservata",
                              tipo_serie=="predfitted"~"Forecast",
                               TRUE~"Counterfactual"))->dati2
```

```{r,fig.height=12,fig.width=10}
ggplot(data=dati2,aes(x=date,y=value))+
  geom_line(aes(color=tipo_serie))+
  facet_wrap(~station_eu_code,ncol=6,scales = "free_y")+
  theme_bw()
```
