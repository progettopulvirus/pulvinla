---
title: "Analisi modelli ARIMAX, NO2"
description: "Serie gennaio-maggio 2020"
author: Michela Cameletti
date: 03-15-2021
params:
  regione: lombardia
  inquinante: no2
output:
  distill::distill_article:
    self_contained: false
---


```{r intro,include=FALSE,echo=FALSE,warning=FALSE,message=FALSE}
library("tidyverse")
library("patchwork")
library("sf")
library("sp")
library("skimr")
library("leaflet")
library("lubridate")
library("rpulvinla")
library("regioniItalia")
library("stazioniMonitoraggio")

knitr::opts_chunk$set(layout="l-body-outset",warning = FALSE,message = FALSE,echo=FALSE,fig.height=4,include = TRUE,eval = TRUE)

#tema per ggplot
theme_set(theme_bw()+
            theme(axis.title.x = element_text(size = rel(2.)),
                  axis.text.x = element_text(size = rel(2.)),
                  axis.title.y = element_text(size = rel(2.)),
                  axis.text.y = element_text(size = rel(2.)),
                  legend.text = element_text(size = rel(1.5)),
                  legend.title = element_text(size = rel(2))))

set.seed(1)
```

# `r params$inquinante`  


```{r leggiRisultati,include=FALSE}
readRDS(glue::glue("_out_pvalues_{params$inquinante}.RDS"))->out_pvalues

# Create a table with the significative change in the level and/or trend slope
LABELS<-c("no effect", "level only","slope only", "level & slope")
out_pvalues %>%
   mutate(lockdown_sign= ifelse(out_pvalues$lockdown<0.05, 1, 0)) %>%
   mutate(bandalockdown_sign= ifelse(out_pvalues$bandalockdown<0.05, 1, 0)) %>%
   mutate(sign=case_when(lockdown_sign==0 & bandalockdown_sign == 0 ~ 1,
                         lockdown_sign==1 & bandalockdown_sign == 0 ~ 2,
                         lockdown_sign==0 & bandalockdown_sign == 1 ~ 3,
                         lockdown_sign==1 & bandalockdown_sign == 1 ~ 4)) %>%
                         mutate(sign = factor(sign,levels = 1:4,labels=LABELS))->out_pvalues


left_join(out_pvalues,stazioni[,c("station_eu_code","st_x","st_y","zona_tipo")])->out_pvalues
```

Il periodo del lockdown va dal 9 marzo al 3 maggio 2021.

---

## P-values


```{r}
table(out_pvalues[,c("sign","zona_tipo")])
```

---

```{r}
DT::datatable(out_pvalues %>% 
                dplyr::select(station_eu_code,sign,zona_tipo))
```

---

### Mappa stazioni

```{r}

awesomeIcons(library="fa",markerColor = "white",icon="asterisk")->noeffect_icon
awesomeIcons(library="fa",markerColor = "lightblue",icon="arrows-alt-v")->levelonly_icon
awesomeIcons(library="fa",markerColor = "blue",icon="chart-line")->slopeonly_icon
awesomeIcons(library="fa",markerColor = "lightred",icon="cut")->levelslope_icon


leaflet() %>%
  addTiles()->map

st_transform(lombardia,crs=4326)->lombardia

map %>%
  #addPolygons(data=lombardia,opacity = 0.25,weight = 0.5)%>%
  addAwesomeMarkers(data=out_pvalues %>% filter(sign=="no effect"),lat=~st_y,lng=~st_x,group = "No effect",icon = noeffect_icon,popup = ~station_eu_code) %>%
  addAwesomeMarkers(data=out_pvalues %>% filter(sign=="level only"),lat=~st_y,lng=~st_x,group="Level only",icon = levelonly_icon,popup = ~station_eu_code) %>%
  addAwesomeMarkers(data=out_pvalues %>% filter(sign=="slope only"),lat=~st_y,lng=~st_x,group="Slope only",icon = slopeonly_icon,popup = ~station_eu_code) %>%
  addAwesomeMarkers(data=out_pvalues %>% filter(sign=="level & slope"),lat=~st_y,lng=~st_x,group="Level & slope",icon = levelslope_icon,popup = ~station_eu_code)%>%
  addLayersControl(overlayGroups = c("No effect","Level only","Slope only","Level & slope"),options = layersControlOptions(collapsed=FALSE))


```


```{r,eval=FALSE}
annotation1 <- data.frame(x = ymd("2020-03-08"),y = 5,label = c("Lockdown"))
readRDS(glue::glue("_dati_staz_{params$inquinante}.RDS"))->dati_staz

unique(dati_staz$station_eu_code)->CODICI

purrr::map(CODICI,.f=function(.codice){
  
  dati_staz %>%
    filter(station_eu_code==.codice)->subDati
  

        ggplot(data=subDati) +
        geom_line(aes(x=date,y=value,col="Observed"),size=0.5) +
        geom_line(aes(x=date,y=predfitted,col = "Fitted"),size=0.5) +
        geom_line(aes(x=date,y=predcounterf,col= "Counterfactual"),linetype=2,size=0.5) +
        geom_vline(aes(xintercept=annotation1$x),linetype=2, size=1.5, col="darkgreen") + 
        geom_label(data=annotation1, aes(x=x, y=y, label=label),color="orange", size=6 , angle=45, fontface="bold") +
        labs(color="", y=bquote(glue::glue("{params$inquinante} concentration (" ~ mu ~ g/m^3 ~ ")")))+
        labs(title=glue::glue("{params$inquinante} - {.codice}"))
        
})->listaGrafici 
```

```{r,fig.width=10,fig.height=6,eval=FALSE}
listaGrafici[[1]]+listaGrafici[[2]]+listaGrafici[[3]]+listaGrafici[[4]]+plot_layout(ncol=2,nrow=2)
```
