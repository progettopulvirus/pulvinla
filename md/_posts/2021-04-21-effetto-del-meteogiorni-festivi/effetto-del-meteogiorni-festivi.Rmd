---
title: "Effetto del meteo,giorni festivi e feriali"
description: |
  Confronto effetto meteo con o senza spde, Lombardia.
author:
  - name: guidofioravanti
date: 04-21-2021
output:
  distill::distill_article:
    self_contained: true
---

Due modelli:

- modello con spde+ cams + meteo

- modello con cams + meteo (no_spde)

- 1. Usando inla.posterior.sample: 1000 samples per ciascun modello.

- 2. Per ciascuna stazione (station_eu_code), anno, feriale/festivo calcolo la media mensile (e.g.: media aprile 2019 per la stazione X per i giorni festivi) sia nel caso del modello con spde che nel caso del modello senza spde.

- 3. Rapporto (variazione) media 2019 vs 2020.


```{r setup,include=FALSE,message=FALSE,warning=FALSE,echo=FALSE}
rm(list = objects())
library("tidyverse")
library("patchwork")
library("vroom")

knitr::opts_chunk$set(layout="l-page")

list.files(pattern="^samples[1-4].csv$")->ffile
purrr::map_dfr(ffile,.f=vroom,delim=";",col_names = TRUE)->df1
df1$tipo<-"senza_meteo"

list.files(pattern="^samples[1-4]_meteo.csv$")->ffile
purrr::map_dfr(ffile,.f=vroom,delim=";",col_names = TRUE)->df2
df2$tipo<-"con_meteo"


bind_rows(df1,df2)->ris1
ris1$spde<-"spde"

#senza spde

list.files(pattern="^samples[1-4].csv$",path = "../ris_senza_spde/",full.names = TRUE)->ffile
purrr::map_dfr(ffile,.f=vroom,delim=";",col_names = TRUE)->df3
df3$tipo<-"senza_meteo"

list.files(pattern="^samples[1-4]_meteo.csv$",path = "../ris_senza_spde/",full.names = TRUE)->ffile
purrr::map_dfr(ffile,.f=vroom,delim=";",col_names = TRUE)->df4
df4$tipo<-"con_meteo"


bind_rows(df3,df4)->ris2
ris2$spde<-"no_spde"


bind_rows(ris1,ris2)->ris

ris %>%
  mutate(week=lubridate::isoweek(date)) %>%
  dplyr::select(yy,mm,week,station_eu_code,weekend,tipo,spde,matches("^sample.+"))->ris

ris %>%
  gather(key="sample",value="svalue",-yy,-mm,-station_eu_code,-weekend,-week,-tipo,-spde)->gris


gris %>%
  group_by(mm,yy,station_eu_code,tipo,spde, weekend,week) %>%
  summarise(media=mean(svalue,na.rm=TRUE)) %>%
  ungroup()  %>%
  spread(key=yy,value=media) %>%
  mutate(rapporto=((`2020`-`2019`)),mm_week=glue::glue("{mm}_{week}"))->finale
```

### Giorni festivi

```{r,include=TRUE,echo=FALSE,fig.width=18,fig.height=8}
ggplot(data=finale %>% filter(weekend==1) %>% mutate(week=factor(week,levels=1:18,ordered=TRUE)))+
  geom_boxplot(aes(x=week,y=rapporto,fill=as.character(tipo)))+
  #scale_y_continuous(limits=c(0.5,4),breaks = seq(0.5,4,0.25))+
  facet_wrap(~as.character(spde),nrow = 2)+
  ggtitle("Giorno Festivi")
```

### Giorni feriali

```{r,include=TRUE,echo=FALSE,fig.width=18,fig.height=8}
ggplot(data=finale %>% filter(weekend==0) %>% mutate(week=factor(week,levels=1:18,ordered=TRUE)))+
  geom_boxplot(aes(x=week,y=rapporto,fill=as.character(tipo)))+
  #scale_y_continuous(limits=c(0.5,2),breaks = seq(0.5,2,0.25))+
  facet_wrap(~as.character(spde),nrow=2)+
  ggtitle("Giorno Feriali")
```

### Tutti i giorni

```{r,fig.width=18,fig.height=10,include==TRUE,echo=FALSE}
bind_rows(ris1,ris2)->ris

ris %>%
  mutate(giorno=lubridate::yday(date)) %>%
  dplyr::select(yy,mm,giorno,station_eu_code,weekend,tipo,spde,matches("^sample.+"))->ris

ris %>%
  gather(key="sample",value="svalue",-yy,-mm,-giorno,-station_eu_code,-weekend,-tipo,-spde)->gris

gris %>%
  group_by(yy,giorno,station_eu_code,tipo,spde) %>%
  summarise(media=mean(svalue,na.rm=TRUE)) %>%
  ungroup()  %>%
  spread(key=yy,value=media) %>%
  mutate(rapporto=((`2020`-`2019`)))->finale

ggplot(data=finale %>% mutate(giorno=factor(giorno,levels=1:121,ordered=TRUE,labels = 1:121)) )+
  # geom_hline(yintercept=1,colour="black")+
  # geom_hline(yintercept=1.1,colour="black")+
  # geom_hline(yintercept=1.2,colour="black")+
  geom_boxplot(aes(x=giorno,y=rapporto,fill=as.character(tipo)))+
  # scale_y_continuous(limits=c(0.5,2),breaks = seq(0.5,2,0.25))+
  facet_wrap(~as.character(spde),nrow=2)+
  ggtitle("Giorni")+
  theme(axis.text.x.bottom = element_text(angle=90))
```